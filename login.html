<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>INRL AR — Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="min-h-screen bg-gray-100 flex items-center justify-center">
    <div class="w-full max-w-md bg-white rounded shadow p-6">
  <h1 class="text-2xl font-bold mb-4">INRL AR — Sign in</h1>

      <div id="message" class="text-sm text-red-600 mb-2"></div>

      <label class="block text-sm">Email</label>
      <input id="email" type="email" class="w-full border rounded p-2 mb-3" />

      <label class="block text-sm">Password</label>
      <input id="password" type="password" class="w-full border rounded p-2 mb-4" />

      <div class="flex gap-2">
        <button id="signin" class="flex-1 bg-blue-600 text-white rounded p-2">Sign in</button>
        <button id="signup" class="flex-1 bg-gray-200 rounded p-2">Sign up</button>
      </div>

      <p class="text-xs text-gray-400 mt-4">After signing in you'll be redirected to the dashboard (admins and brand users share the same login).</p>
    </div>

    <script>
  const SUPABASE_URL = "https://cxcbgrhqujgrrmkqcewv.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_kdk75aMwV6efd8Fcs1AsoA_a905uRWO";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const emailEl = document.getElementById('email');
      const passEl = document.getElementById('password');
      const signInBtn = document.getElementById('signin');
      const signUpBtn = document.getElementById('signup');
  // magic link removed from this page — registration and invite flows live on register pages
      const msg = document.getElementById('message');

      async function showError(e) {
        console.error('Auth error:', e);
        // supabase-js error objects sometimes have .message and sometimes nested info
        const text = e?.message || (e?.error_description) || JSON.stringify(e);
        msg.textContent = text;
        setTimeout(() => msg.textContent = '', 8000);
      }

      // If already signed in, check role and redirect to appropriate dashboard
      (async () => {
        try {
          const { data } = await supabase.auth.getSession();
          const session = data?.session || null;
          if (!session) return; // not signed in
          const user = session.user;

          // Prefer RPCs if you have them; fallback to table selects (may be blocked under RLS)
          try {
            // Prefer RPC is_admin() if available (safer under RLS). Fallback to table select.
            try {
              const { data: isAdm, error: rpcErr } = await supabase.rpc('is_admin');
              if (!rpcErr && isAdm === true) { window.location.href = '/admin.html'; return; }
            } catch (e) {
              // ignore rpc errors and fallback
            }

            const { data: adminRow, error: adminErr } = await supabase.from('admins').select('user_id,id').or(`user_id.eq.${user.id},id.eq.${user.id}`).maybeSingle();
            if (!adminErr && adminRow && (adminRow.user_id === user.id || adminRow.id === user.id)) {
              window.location.href = '/admin.html';
              return;
            }
          } catch (e) {
            console.warn('Admin check failed:', e);
          }

          // check profile.brand
          try {
            const { data: prof, error: profErr } = await supabase.from('profiles').select('brand').eq('user_id', user.id).maybeSingle();
            if (!profErr && prof && prof.brand) {
              window.location.href = '/brand.html';
              return;
            }
          } catch (e) {
            console.warn('Profile check failed:', e);
          }

          // default to client view
          window.location.href = '/client.html';
        } catch (e) {
          console.warn('Session check failed', e);
        }
      })();

      signInBtn.addEventListener('click', async () => {
        try {
          const email = emailEl.value.trim();
          const password = passEl.value;
          if (!email || !password) return showError('Enter email and password');
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) return showError(error);
          // signed in -> route by role
          try {
            const { data: sessionData } = await supabase.auth.getSession();
            const user = sessionData?.data?.session?.user || sessionData?.session?.user || null;
            if (!user) { window.location.href = '/client.html'; return; }
            try {
              const { data: isAdm, error: rpcErr } = await supabase.rpc('is_admin');
              if (!rpcErr && isAdm === true) { window.location.href = '/admin.html'; return; }
            } catch (e) {}
            const { data: adminRow } = await supabase.from('admins').select('user_id,id').or(`user_id.eq.${user.id},id.eq.${user.id}`).maybeSingle();
            if (adminRow && (adminRow.user_id === user.id || adminRow.id === user.id)) { window.location.href = '/admin.html'; return; }
            const { data: prof } = await supabase.from('profiles').select('brand').eq('user_id', user.id).maybeSingle();
            if (prof && prof.brand) { window.location.href = '/brand.html'; return; }
          } catch (e) {
            console.warn('Post-login routing failed, falling back to client.html', e);
          }
          window.location.href = '/client.html';
        } catch (e) { showError(e); }
      });

      signUpBtn.addEventListener('click', () => {
        // Redirect to brand/client registration page; registration flow lives in register.html
        window.location.href = '/register.html';
      });

      // no magic link button on this page; use /register.html or admin invite flows instead
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR + Supabase (Secure)</title>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

      // Public values (safe for frontend)
      const SUPABASE_URL = "https://vleqrpqfjkcazeowczjy.supabase.co"
      const SUPABASE_ANON_KEY = "sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ"
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

      // This calls your deployed Supabase Edge Function
      const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/generate-mind`

      async function handleUpload(file, videoUrl) {
        // Upload to your "assets" bucket
        const { data, error } = await supabase.storage.from("assets").upload(`uploads/${file.name}`, file, {
          upsert: true,
        })
        if (error) throw error

        const { data: publicUrl } = supabase.storage.from("assets").getPublicUrl(`uploads/${file.name}`)
        const imageUrl = publicUrl.publicUrl

        // Call Supabase Function securely
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl, videoUrl }),
        })

        const result = await res.json()
        if (result.error) throw result.error
        alert("âœ… .mind created: " + result.mindUrl)
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
          e.preventDefault()
          const file = document.getElementById("fileInput").files[0]
          const videoUrl = document.getElementById("videoUrl").value
          if (!file || !videoUrl) return alert("Please select an image and video URL")
          await handleUpload(file, videoUrl)
        })
      })
    </script>
  </head>

  <body>
    <h2>ðŸ§  Upload Image to Auto-Convert (.mind)</h2>
    <form id="uploadForm">
      <input type="file" id="fileInput" accept="image/png,image/jpeg" required />
      <input type="text" id="videoUrl" placeholder="Video URL" required />
      <button type="submit">Upload & Convert</button>
    </form>
  </body>
</html>

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>INRL AR Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 700px;
        margin: 40px auto;
        padding: 20px;
      }
      label { font-weight: 600; }
      input[type="text"], input[type="file"] {
        width: 100%; padding: 8px; margin-top: 4px;
      }
      button {
        padding: 8px 16px; margin-top: 10px; cursor: pointer;
      }
      table {
        width: 100%; border-collapse: collapse; margin-top: 30px;
      }
      th, td {
        border-bottom: 1px solid #ccc; padding: 8px; text-align: left;
      }
      .active-row { background: #e6ffe6; }
    </style>
  </head>

  <body>
    <h2>üéõÔ∏è TUP GEAR AR Admin Panel</h2>
    <p>Upload a new image target and video, and choose the active one.</p>

    <label>Target name:</label>
    <input id="name" type="text" placeholder="Target name" />

    <label>.mind file:</label>
    <input type="file" id="mindFile" accept=".mind" />

    <label>.mp4 video:</label>
    <input type="file" id="videoFile" accept="video/mp4" />

    <label style="margin-top:10px;">
      <input type="checkbox" id="makeActive" /> Make this the active target
    </label>

    <br />
    <button id="upload">Upload Target</button>
    <p id="status"></p>

    <h3>üìã Existing Targets</h3>
    <table id="targetsTable">
      <thead>
        <tr><th>Name</th><th>Created</th><th>Active</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const SUPABASE_URL = "https://vleqrpqfjkcazeowczjy.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const uploadBtn = document.getElementById("upload");
      const statusEl = document.getElementById("status");
      const tableBody = document.querySelector("#targetsTable tbody");

      // Load existing targets on page load
      document.addEventListener("DOMContentLoaded", loadTargets);

      async function loadTargets() {
        const { data, error } = await supabase.from("targets").select("*").order("created_at", { ascending: false });
        if (error) {
          console.error(error);
          statusEl.textContent = "‚ùå Error loading targets: " + error.message;
          return;
        }

        tableBody.innerHTML = "";
        data.forEach((t) => {
          const tr = document.createElement("tr");
          if (t.is_active) tr.classList.add("active-row");

          tr.innerHTML = `
            <td>${t.name}</td>
            <td>${new Date(t.created_at).toLocaleString()}</td>
            <td>${t.is_active ? "‚úÖ Active" : ""}</td>
            <td><button data-id="${t.id}">Set Active</button></td>
          `;
          tableBody.appendChild(tr);
        });

        // Bind click handlers
        document.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("click", () => setActive(btn.dataset.id));
        });
      }

      async function setActive(id) {
        statusEl.textContent = "Updating active target...";

        // set all inactive
        await supabase.from("targets").update({ is_active: false }).neq("id", id);
        // set chosen active
        const { error } = await supabase.from("targets").update({ is_active: true }).eq("id", id);

        if (error) {
          statusEl.textContent = "‚ùå Failed to set active: " + error.message;
        } else {
          statusEl.textContent = "‚úÖ Active target updated.";
          loadTargets();
        }
      }

      uploadBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value.trim();
        const mind = document.getElementById("mindFile").files[0];
        const video = document.getElementById("videoFile").files[0];
        const makeActive = document.getElementById("makeActive").checked;

        if (!name || !mind || !video) {
          alert("‚ö†Ô∏è Please fill in all fields and choose files.");
          return;
        }

        statusEl.textContent = "Uploading files... ‚è≥";

        const mindPath = `minds/${Date.now()}-${mind.name}`;
        const videoPath = `videos/${Date.now()}-${video.name}`;

        const { error: mindErr } = await supabase.storage.from("assets").upload(mindPath, mind);
        if (mindErr) return (statusEl.textContent = "‚ùå Mind upload failed: " + mindErr.message);

        const { error: vidErr } = await supabase.storage.from("assets").upload(videoPath, video);
        if (vidErr) return (statusEl.textContent = "‚ùå Video upload failed: " + vidErr.message);

        const mindUrl = supabase.storage.from("assets").getPublicUrl(mindPath).data.publicUrl;
        const videoUrl = supabase.storage.from("assets").getPublicUrl(videoPath).data.publicUrl;

        // if makeActive, clear others first
        if (makeActive) {
          await supabase.from("targets").update({ is_active: false }).neq("name", name);
        }

        const { error: dbErr } = await supabase
          .from("targets")
          .insert([{ name, mindUrl, videoUrl, is_active: makeActive }]);

        if (dbErr) return (statusEl.textContent = "‚ùå DB insert failed: " + dbErr.message);

        statusEl.textContent = "‚úÖ Upload complete!";
        document.getElementById("name").value = "";
        document.getElementById("mindFile").value = "";
        document.getElementById("videoFile").value = "";
        document.getElementById("makeActive").checked = false;
        loadTargets();
      });
    </script>
  </body>
</html>

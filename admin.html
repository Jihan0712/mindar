<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TUP GEAR AR Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body style="font-family:sans-serif; max-width:700px; margin:40px auto;">
    <h2>üéõÔ∏è TUP GEAR AR Admin Panel</h2>

    <p>Upload a new target and choose which one is active for AR display.</p>

    <label>Target name:</label><br>
    <input id="name" placeholder="Target name" style="width:100%; padding:8px;"><br><br>

    <label>.mind file:</label><br>
    <input type="file" id="mindFile" accept=".mind"><br><br>

    <label>.mp4 video:</label><br>
    <input type="file" id="videoFile" accept="video/mp4"><br><br>

    <button id="upload" style="padding:10px 20px;">Upload</button>
    <p id="status"></p>

    <hr>
    <h3>üìã Existing Targets</h3>
    <table border="1" cellspacing="0" cellpadding="8" width="100%">
      <thead>
        <tr>
          <th>Name</th>
          <th>Created</th>
          <th>Active</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="targets"></tbody>
    </table>

    <script>
      const SUPABASE_URL = "https://vleqrpqfjkcazeowczjy.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const uploadBtn = document.getElementById("upload");
      const statusEl = document.getElementById("status");
      const targetsEl = document.getElementById("targets");

      // üîπ Load targets from database
      async function loadTargets() {
        const { data, error } = await supabase
          .from("targets")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error loading targets:", error);
          statusEl.textContent = "‚ùå Failed to load targets: " + error.message;
          return;
        }

        targetsEl.innerHTML = "";
        data.forEach((t) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.name}</td>
            <td>${new Date(t.created_at).toLocaleString()}</td>
            <td>${t.is_active ? "‚úÖ" : "‚ùå"}</td>
            <td><button data-id="${t.id}" class="set-active">Set Active</button></td>
          `;
          targetsEl.appendChild(tr);
        });

        // Add event listeners
        document.querySelectorAll(".set-active").forEach((btn) => {
          btn.addEventListener("click", () => setActive(btn.getAttribute("data-id")));
        });
      }

      // üîπ Set a target active
      async function setActive(targetId) {
        try {
          statusEl.textContent = "Updating active target...";

          // 1Ô∏è‚É£ Reset all to false
          const { error: resetErr } = await supabase
            .from("targets")
            .update({ is_active: false })
            .neq("id", targetId);

          if (resetErr) throw resetErr;

          // 2Ô∏è‚É£ Set selected target to true
          const { error: setErr } = await supabase
            .from("targets")
            .update({ is_active: true })
            .eq("id", targetId);

          if (setErr) throw setErr;

          statusEl.textContent = "‚úÖ Active target updated!";
          await loadTargets();
        } catch (err) {
          console.error("Error updating active target:", err);
          statusEl.textContent = "‚ùå Error updating: " + err.message;
        }
      }

      // üîπ Upload handler
      uploadBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value;
        const mind = document.getElementById("mindFile").files[0];
        const video = document.getElementById("videoFile").files[0];

        if (!mind || !video || !name) {
          alert("‚ö†Ô∏è Please fill all fields and choose files.");
          return;
        }

        statusEl.textContent = "Uploading... ‚è≥";

        const mindPath = `minds/${Date.now()}-${mind.name}`;
        const videoPath = `videos/${Date.now()}-${video.name}`;

        // Upload mind file
        const { error: mindErr } = await supabase.storage
          .from("assets")
          .upload(mindPath, mind, { upsert: false });
        if (mindErr) {
          statusEl.textContent = "‚ùå Mind upload failed: " + mindErr.message;
          return;
        }

        // Upload video
        const { error: vidErr } = await supabase.storage
          .from("assets")
          .upload(videoPath, video, { upsert: false });
        if (vidErr) {
          statusEl.textContent = "‚ùå Video upload failed: " + vidErr.message;
          return;
        }

        // Get public URLs
        const mindUrl = supabase.storage.from("assets").getPublicUrl(mindPath).data.publicUrl;
        const videoUrl = supabase.storage.from("assets").getPublicUrl(videoPath).data.publicUrl;

        // Insert into DB
        const { error: dbErr } = await supabase
          .from("targets")
          .insert([{ name, mindUrl, videoUrl, is_active: false }]);

        if (dbErr) {
          statusEl.textContent = "‚ùå Database insert failed: " + dbErr.message;
          return;
        }

        statusEl.textContent = "‚úÖ Upload complete!";
        document.getElementById("name").value = "";
        document.getElementById("mindFile").value = "";
        document.getElementById("videoFile").value = "";

        await loadTargets();
      });

      loadTargets();
    </script>
  </body>
</html>

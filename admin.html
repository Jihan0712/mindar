<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TUP GEAR AR Admin</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Dropzone -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/min/dropzone.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.2/dropzone.min.css">

  <!-- TensorFlow.js (use CPU backend) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 16px;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 6px 0 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .dropzone {
      border: 2px dashed #4a90e2;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background-color: #f9fbff;
      margin: 10px 0;
      min-height: 120px;
      cursor: pointer;
    }
    .dropzone:hover {
      background-color: #eaf3ff;
    }
    button {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 8px 0;
      width: 100%;
    }
    button:hover {
      background-color: #357abd;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #progress {
      font-weight: bold;
      color: #2c6fbb;
      display: block;
      margin: 10px 0;
    }
    .error {
      color: #d32f2f;
      font-weight: bold;
    }
    #container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    #container canvas {
      max-width: 100%;
      border: 1px solid #eee;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .step {
      background: #f0f7ff;
      padding: 12px;
      border-left: 4px solid #4a90e2;
      margin: 16px 0;
    }
    .info {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>üéõÔ∏è AR Admin Control Panel</h2>
  <p>Upload an image (JPG/PNG) ‚Üí convert to .mind ‚Üí upload video ‚Üí go live!</p>

  <label for="name">Target Name</label>
  <input id="name" type="text" placeholder="e.g., TUP Poster" />

  <div class="step">
    <strong>Step 1: Upload Image (JPG/PNG)</strong>
    <div id="imageDropzone" class="dropzone">
      <p>Drag & drop your image here<br>or click to browse</p>
    </div>
    <button id="startCompile">Generate .mind File</button>
    <span id="progress"></span>
    <div id="container"></div>
    <p class="info">üí° Tip: Use images 300‚Äì800px for best results.</p>
  </div>

  <div class="step">
    <strong>Step 2: Upload Video (.mp4)</strong>
    <input type="file" id="videoFile" accept="video/mp4" />
  </div>

  <button id="uploadToSupabase">üì§ Upload to Supabase</button>
  <p id="status"></p>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://vleqrpqfjkcazeowczjy.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ';

    // === INIT ===
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let compiler = null;
    let generatedMindBlob = null;
    let imageDropzone = null;

    // Wait for all scripts to load
    document.addEventListener('DOMContentLoaded', async () => {
      const statusEl = document.getElementById('status');

      try {
        // Set TensorFlow.js to use CPU backend
        await tf.setBackend('cpu');
        console.log("‚úÖ TensorFlow.js using CPU backend");

        // Load MindAR SDK
        const mindarModule = await import("https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js");
        
        if (!mindarModule.Compiler) {
          throw new Error("MindAR Compiler not available");
        }

        compiler = new mindarModule.Compiler();
        statusEl.textContent = '‚úÖ Ready! Upload an image to begin.';
        console.log("‚úÖ MindAR Compiler initialized");

        // Initialize Dropzone only if not already attached
        if (typeof Dropzone !== 'undefined') {
          if (!Dropzone.instances.some(instance => instance.element.id === 'imageDropzone')) {
            imageDropzone = new Dropzone("#imageDropzone", {
              url: "#",
              autoProcessQueue: false,
              addRemoveLinks: true,
              acceptedFiles: "image/jpeg,image/png",
              dictDefaultMessage: "Drop image here or click",
              maxFilesize: 5, // MB
              clickable: true, // Make sure it's clickable
              previewsContainer: false, // Hide default preview
            });

            // Optional: Show file name after upload
            imageDropzone.on("addedfile", function(file) {
              document.getElementById('progress').textContent = `Selected: ${file.name}`;
            });

          } else {
            console.warn("‚ö†Ô∏è Dropzone already attached to #imageDropzone");
            imageDropzone = Dropzone.forElement('#imageDropzone');
          }
        } else {
          throw new Error("Dropzone.js not loaded");
        }

      } catch (err) {
        console.error("‚ùå Initialization failed:", err);
        statusEl.innerHTML = `<span class="error">‚ùå Failed to load processor: ${err.message}<br>Please use Chrome or Firefox.</span>`;
      }
    });

    // === COMPILE IMAGE TO .MIND ===
    document.getElementById('startCompile').addEventListener('click', async () => {
      if (!imageDropzone) {
        alert('‚ö†Ô∏è Dropzone not initialized.');
        return;
      }

      const files = imageDropzone.files;
      if (files.length === 0) {
        alert('‚ö†Ô∏è Please upload an image first.');
        return;
      }

      const imageFile = files[0];
      const ext = imageFile.name.split('.').pop().toLowerCase();
      if (!['jpg', 'jpeg', 'png'].includes(ext)) {
        alert('‚ö†Ô∏è Only JPG or PNG images are supported.');
        return;
      }

      const progressEl = document.getElementById('progress');
      progressEl.textContent = 'Processing...';

      try {
        // Load image as ImageBitmap
        const arrayBuf = await imageFile.arrayBuffer();
        const blob = new Blob([arrayBuf], { type: imageFile.type });
        const imageBitmap = await createImageBitmap(blob);

        // Validate size
        if (imageBitmap.width > 1000 || imageBitmap.height > 1000) {
          throw new Error("Image too large! Please resize to under 1000x1000px.");
        }
        if (imageBitmap.width < 300 || imageBitmap.height < 300) {
          throw new Error("Image too small! Please use at least 300x300px.");
        }

        // Create canvas and draw image
        const canvas = document.createElement('canvas');
        canvas.width = imageBitmap.width;
        canvas.height = imageBitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imageBitmap, 0, 0);

        // Get ImageData
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Compile
        const start = Date.now();
        const dataList = await compiler.compileImageTargets([imageData], (progress) => {
          progressEl.textContent = `Progress: ${(progress * 100).toFixed(1)}%`;
        });

        console.log(`‚è±Ô∏è Compilation took ${Date.now() - start} ms`);

        // Export .mind
        const buffer = await compiler.exportData();
        generatedMindBlob = new Blob([buffer], { type: 'application/octet-stream' });

        progressEl.textContent = '‚úÖ .mind file generated!';
        showDebugImages(dataList, imageData);

      } catch (err) {
        console.error("‚ùå Compilation error:", err);
        progressEl.textContent = '‚ùå Failed to generate .mind file.';
        document.getElementById('status').innerHTML = `<span class="error">‚ùå ${err.message}</span>`;
      }
    });

    // === SHOW DEBUG POINTS ===
    function showDebugImages(dataList, originalImageData) {
      const container = document.getElementById('container');
      container.innerHTML = '';

      dataList.forEach((data) => {
        const canvas = document.createElement('canvas');
        canvas.width = originalImageData.width;
        canvas.height = originalImageData.height;
        const ctx = canvas.getContext('2d');
        ctx.putImageData(originalImageData, 0, 0);

        // Draw feature points
        const points = data.trackingData?.[0]?.points || [];
        ctx.strokeStyle = '#ff0000';
        ctx.fillStyle = '#ff0000';
        points.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
        });

        container.appendChild(canvas);
      });
    }

    // === UPLOAD TO SUPABASE ===
    document.getElementById('uploadToSupabase').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim();
      const videoFile = document.getElementById('videoFile').files[0];

      if (!name) {
        alert('‚ö†Ô∏è Please enter a target name.');
        return;
      }
      if (!generatedMindBlob) {
        alert('‚ö†Ô∏è Please generate a .mind file first.');
        return;
      }
      if (!videoFile) {
        alert('‚ö†Ô∏è Please upload a video.');
        return;
      }

      const statusEl = document.getElementById('status');
      statusEl.textContent = 'üì§ Uploading to Supabase...';

      try {
        const timestamp = Date.now();
        const mindPath = `minds/${timestamp}-${encodeURIComponent(name)}.mind`;
        const videoPath = `videos/${timestamp}-${encodeURIComponent(videoFile.name)}`;

        // Upload .mind
        const { error: mindErr } = await supabase.storage
          .from('assets')
          .upload(mindPath, generatedMindBlob, { contentType: 'application/octet-stream' });
        if (mindErr) throw mindErr;

        // Upload video
        const { error: vidErr } = await supabase.storage
          .from('assets')
          .upload(videoPath, videoFile, { contentType: 'video/mp4' });
        if (vidErr) throw vidErr;

        // Get public URLs
        const {  mindData } = supabase.storage.from('assets').getPublicUrl(mindPath);
        const {  videoData } = supabase.storage.from('assets').getPublicUrl(videoPath);

        // Save to DB
        const { error: dbErr } = await supabase
          .from('targets')
          .insert([{ name, mindUrl: mindData.publicUrl, videoUrl: videoData.publicUrl }]);
        if (dbErr) throw dbErr;

        // Success!
        statusEl.textContent = '‚úÖ Success! AR target is live.';
        // Reset
        document.getElementById('name').value = '';
        imageDropzone.removeAllFiles(true);
        document.getElementById('videoFile').value = '';
        generatedMindBlob = null;
        document.getElementById('container').innerHTML = '';
        document.getElementById('progress').textContent = '';

      } catch (err) {
        console.error('Supabase upload error:', err);
        statusEl.innerHTML = `<span class="error">‚ùå Upload failed: ${err.message}</span>`;
      }
    });
  </script>
</body>
</html>